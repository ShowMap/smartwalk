EventViewModelExtended=function(n,t){var i=this;EventViewModelExtended.superClass_.constructor.call(i,t);i.settings=n;i.data=new EventViewModel(t);i.actualVenues=function(){return i.data.venues()?$.grep(i.data.venues(),function(n){return n.id()>0&&!n._destroy}):[]};EventViewModelExtended.setupAutocomplete(i);EventViewModelExtended.setupMultiday(i);EventViewModelExtended.setupSorting(i);EventViewModelExtended.setupDialogs(i);i.venuesManager=new VmItemsManager(i.data.venues,function(){return new EntityViewModel({Type:sw.vm.EntityType.Venue})},{initItem:function(n){EventViewModelExtended.initVenueViewModel(n,i)},beforeEdit:function(){i.data.venues().forEach(function(n){n.showsManager.cancelAll()})},beforeSave:function(n){n.errors||EventViewModelExtended.setupVenueValidation(n,i.settings)},afterSave:function(n){n.eventDetail().sortOrder()||n.eventDetail().sortOrder(i.actualVenues().length)},afterDelete:function(){i.data.venueOrderType()==sw.vm.VenueOrderType.Custom&&i.updateVenueDetailOrder()},itemView:i.settings.eventVenueView,itemEditView:i.settings.eventVenueEditView});i.sortVenues();i.createVenue=function(){$(i.settings.venueFormName).dialog("open")};i.createHost=function(){$(i.settings.hostFormName).dialog("open")};i.saveEvent=function(){return(i.data.errors||EventViewModelExtended.setupValidation(i.data,n),i.data.isValidating())?(setTimeout(function(){i.saveEvent()},50),!1):(i.data.errors().length==0?i.currentRequest=sw.ajaxJsonRequest(i.data.toJSON.apply(i.data),i.settings.eventSaveUrl,function(n){i.settings.eventAfterSaveAction(n.Id,i)},function(n){i.handleServerError(n)},i):i.data.errors.showAllMessages(),!0)};i.cancelEvent=function(){i.isBusy()?i.isBusy(!1):i.settings.eventAfterCancelAction(i)}};sw.inherits(EventViewModelExtended,ViewModelBase);EventViewModelExtended.setupValidation=function(n,t){n.title.extend({maxLength:{params:255,message:t.titleLengthValidationMessage}});n.startDate.extend({required:{message:t.startTimeRequiredValidationMessage}}).extend({dateCompareValidation:{params:{allowEmpty:!0,cmp:"LESS_THAN",compareVal:n.endDate},message:t.startTimeCompareValidationMessage}});n.endDate.extend({dateCompareValidation:{params:{allowEmpty:!0,cmp:"GREATER_THAN",compareVal:n.startDate},message:t.endTimeCompareValidationMessage}});n.picture.extend({maxLength:{params:255,message:t.pictureLengthValidationMessage}}).extend({urlValidation:{params:{allowEmpty:!0},message:t.picturePatternValidationMessage}});n.description.extend({maxLength:{params:3e3,message:t.descriptionLengthValidationMessage}});n.host.extend({required:{message:t.hostRequiredValidationMessage}});n.isValidating=ko.computed(function(){return n.title.isValidating()||n.startDate.isValidating()||n.endDate.isValidating()||n.picture.isValidating()||n.description.isValidating()||n.host.isValidating()});n.errors=ko.validation.group(n)};EventViewModelExtended.setupShowValidation=function(n,t,i){n.title.extend({required:{params:!0,message:i.showMessages.titleRequiredValidationMessage}}).extend({maxLength:{params:255,message:i.showMessages.titleLengthValidationMessage}});n.picture.extend({maxLength:{params:255,message:i.showMessages.pictureLengthValidationMessage}}).extend({urlValidation:{params:{allowEmpty:!0},message:i.showMessages.pictureValidationMessage}});n.detailsUrl.extend({maxLength:{params:255,message:i.showMessages.detailsLengthValidationMessage}}).extend({urlValidation:{params:{allowEmpty:!0},message:i.showMessages.detailsValidationMessage}});n.startTime.extend({dateCompareValidation:{params:{allowEmpty:!0,cmp:"LESS_THAN",compareVal:n.endTime},message:i.showMessages.startTimeValidationMessage}}).extend({dateCompareValidation:{params:{allowEmpty:!0,cmp:"REGION",compareVal:ko.computed(function(){return t.startDate()?moment(t.startDate()).subtract(1,"days").toDate():undefined}),compareValTo:ko.computed(function(){return t.endDate()||t.startDate()?moment(t.endDate()||t.startDate()).add(1,"days").toDate():undefined})},message:i.showMessages.startDateValidationMessage}});n.endTime.extend({dateCompareValidation:{params:{allowEmpty:!0,cmp:"GREATER_THAN",compareVal:n.startTime},message:i.showMessages.endTimeValidationMessage}}).extend({dateCompareValidation:{params:{allowEmpty:!0,cmp:"REGION",compareVal:ko.computed(function(){return t.startDate()?moment(t.startDate()).subtract(1,"days").toDate():undefined}),compareValTo:ko.computed(function(){return t.endDate()||t.startDate()?moment(t.endDate()||t.startDate()).add(2,"days").toDate():undefined})},message:i.showMessages.endDateValidationMessage}});n.isValidating=ko.computed(function(){return n.title.isValidating()||n.picture.isValidating()||n.detailsUrl.isValidating()||n.startTime.isValidating()||n.endTime.isValidating()});n.errors=ko.validation.group(n)};EventViewModelExtended.setupVenueValidation=function(n,t){n.id.extend({required:{message:t.venueRequiredValidationMessage}});n.eventDetail().description.extend({maxLength:{params:3e3,message:t.descriptionLengthValidationMessage}});n.errors=ko.validation.group([n.id,n.eventDetail().description])};EventViewModelExtended.initVenueViewModel=function(n,t){n.autocompleteName=ko.pureComputed({read:function(){return n.name()||null},write:function(){}});n.autocompleteData=ko.pureComputed({read:function(){return null},write:function(t){var i=t||{};n.eventDetail()&&(i.EventDetail=n.eventDetail().toJSON.apply(n.eventDetail()));n.shows()&&(i.Shows=$.map(n.shows(),function(n){return n.toJSON.apply(n)}));n.loadData.apply(n,[i])}});n.autocompleteName.extend({notify:"always"});n.name.extend({notify:"always"});n.number=ko.computed(function(){var i=t.data.venueTitleFormatType()==sw.vm.VenueTitleFormatType.NameAndNumber?t.actualVenues().indexOf(n)+1:null;return i?i+". ":""});n.showsManager=new VmItemsManager(n.shows,function(){return new ShowViewModel({})},{setEditingItem:function(n){return t.venuesManager.setEditingItem(n)},filterItem:function(n){return n.isEditing()||EventViewModelExtended.isTimeThisDay(n.startTime(),t,0)},beforeEdit:function(){t.venuesManager.cancelAll();t.data.venues().forEach(function(n){n.showsManager.cancelAll()})},beforeSave:function(n){n.errors||EventViewModelExtended.setupShowValidation(n,t.data,t.settings)},itemView:t.settings.showView,itemEditView:t.settings.showEditView})};EventViewModelExtended.setupAutocomplete=function(n){var t=n;t.autocompleteHostName=ko.pureComputed({read:function(){return t.data.host()?t.data.host().name():null},write:function(){}});t.autocompleteHostData=ko.pureComputed({read:function(){return null},write:function(n){t.data.host(n&&$.isPlainObject(n)?new EntityViewModel(n):null)}});t.data.host.extend({notify:"always"});t.autocompleteHostName.extend({notify:"always"});t.getAutocompleteHosts=function(n,i){sw.ajaxJsonRequest({term:n},t.settings.hostAutocompleteUrl,i)};t.getAutocompleteVenues=function(n,i){sw.ajaxJsonRequest({term:n,excludeIds:$.map(t.actualVenues(),function(n){return n.id()})},t.settings.venueAutocompleteUrl,i)}};EventViewModelExtended.setupMultiday=function(n){var t=n;t.daysCount=ko.computed(function(){return!t.data.startDate()||!t.data.endDate()?0:moment(t.data.endDate()).diff(moment(t.data.startDate()),"days")});t.isMultiday=ko.computed(function(){return t.daysCount()>0});t.days=ko.computed(function(){return t.isMultiday()?Array.apply(0,Array(t.daysCount()+1)).map(function(n,i){return{day:i+1,momentDate:moment(t.data.startDate()).add(i,"days")}}):null});t.currentDate=ko.observable(undefined);t.currentDay=ko.observable(t.isMultiday()?1:undefined);t.currentDay.subscribe(function(n){EventViewModelExtended.setCurrentDate(t,t.data.startDate(),n)});t.data.startDate.subscribe(function(n){EventViewModelExtended.setCurrentDate(t,n,t.currentDay())});t.daysCount.subscribe(function(){t.currentDay(t.isMultiday()?1:undefined)});t.settings.currentDay&&t.currentDay(t.settings.currentDay);EventViewModelExtended.setCurrentDate(t,t.data.startDate(),t.currentDay());t.defaultDate=ko.computed(function(){return t.currentDate()||t.data.startDate()})};EventViewModelExtended.setCurrentDate=function(n,t,i){var r=n;t&&i?r.currentDate(moment(t).add(i-1,"days").toDate()):r.currentDate(undefined)};EventViewModelExtended.isTimeThisDay=function(n,t,i){if(!n||!t.currentDate())return!0;i==0||i||(i=6);var o=moment(n),r=moment(n).startOf("day"),e=moment(t.currentDate()),s=moment(t.currentDate()).add(1,"days"),u=t.data.startDate()?moment(t.data.startDate()):undefined,f=t.data.endDate()||t.data.startDate()?moment(t.data.endDate()||t.data.startDate()):undefined;return u&&(r.isBefore(u)||r.isSame(u))&&e.isSame(u)||r.isSame(e)&&o.hours()>=i||r.isSame(s)&&o.hours()<i||f&&(r.isAfter(f)||r.isSame(f))&&e.isSame(f)};EventViewModelExtended.setupSorting=function(n){var t=n;t.data.venueOrderType.subscribe(function(n){t.sortVenues();n==sw.vm.VenueOrderType.Custom&&t.updateVenueDetailOrder()});t.sortVenues=function(){switch(t.data.venueOrderType()){case sw.vm.VenueOrderType.Name:t.data.venues.sort(function(n,t){return n.name().localeCompare(t.name())});break;case sw.vm.VenueOrderType.Custom:t.data.venues.sort(function(n,t){var i=n.eventDetail()&&n.eventDetail().sortOrder()||0,r=t.eventDetail()&&t.eventDetail().sortOrder()||0;return i==r?0:i<r?-1:1})}};t.updateVenueDetailOrder=function(){var n=1;t.actualVenues().forEach(function(t){t.eventDetail().sortOrder(n++)})};t.moveVenueUp=function(n){var i=n.eventDetail().sortOrder();n.eventDetail().sortOrder(i-1.5);t.sortVenues();t.updateVenueDetailOrder()};t.moveVenueDown=function(n){var i=n.eventDetail().sortOrder();n.eventDetail().sortOrder(i+1.5);t.sortVenues();t.updateVenueDetailOrder()}};EventViewModelExtended.setupDialogs=function(n){var t={modal:!0,autoOpen:!1,resizable:!1,width:700,maxHeight:600,close:function(){var n=ko.dataFor(this);n.isBusy(!1);n.data.loadData.apply(n.data,[{Type:n.data.type()}]);n.resetServerErrors();n.data.errors&&n.data.errors.showAllMessages(!1)}},i=function(){var n=ko.dataFor(this);n.isBusy()?n.isBusy(!1):$(this).dialog("close")},u={title:n.settings.dialogCreateHostText,buttons:[{"class":"btn btn-default",text:n.settings.dialogCancelText,click:i},{"class":"btn btn-success","data-bind":"enable: isEnabled",text:n.settings.dialogAddHostText,click:function(){var t=this,i=ko.dataFor(t);i.saveEntity(function(i){var r=new EntityViewModel(i);n.data.host(r);$(t).dialog("close")})}}]},r;$(n.settings.hostFormName).dialog($.extend(t,u));EventViewModelExtended.setupDialogBottomBar($(n.settings.hostFormName),n.settings.loadingTemplate);r={title:n.settings.dialogCreateVenueText,buttons:[{"class":"btn btn-default",text:n.settings.dialogCancelText,click:i},{"class":"btn btn-success","data-bind":"enable: isEnabled",text:n.settings.dialogAddVenueText,click:function(){var t=this,i=ko.dataFor(t);i.saveEntity(function(i){var r=$.grep(n.data.venues(),function(n){return n.isEditing()})[0];r&&(r.autocompleteData(i),$(t).dialog("close"))})}}]};$(n.settings.venueFormName).dialog($.extend(t,r));EventViewModelExtended.setupDialogBottomBar($(n.settings.venueFormName),n.settings.loadingTemplate)};EventViewModelExtended.setupDialogBottomBar=function(n,t){var i=n.dialog("instance").uiButtonSet,r;$("<span>").attr("data-bind","template: { name: '"+t+"'}").prependTo(i);r=ko.dataFor(n[0]);ko.applyBindings(r,i[0])};
/*
//# sourceMappingURL=sw-editing-event.min.js.map
*/